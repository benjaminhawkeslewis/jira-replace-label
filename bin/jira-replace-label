#!/usr/bin/env python

import jira.client
import jira.exceptions
import requests.exceptions
import sys
import signal
import argparse
import getpass
import jiralabels

def main():
    args = parse_arguments()
    try:
        j = jira.client.JIRA(
            options={
                'server': args.server
            },
            basic_auth=(
                args.user,
                getpass.getpass(
                    'Password for %(user)s@%(server)s:' % {
                        'user': args.user,
                        'server': args.server
                    }
                )
            )
        )
        do_replace_label(j, args.old, args.new)
    except jira.exceptions.JIRAError as e:
        sys.stderr.write("ERROR: JIRA server found but login failed. Check your credentials.\n")
        exit(1)
    except requests.exceptions.ConnectionError as e:
        sys.stderr.write("ERROR: Could not connect to JIRA server.")
        exit(1)

def print_change(issue, old_labels):
    print 'Relabelled %s: %s with %s; was previously labeled %s' % (
        issue.key,
        issue.fields.summary,
        ', '.join(issue.fields.labels),
        ', '.join(old_labels)
    )

def handle_label_event(event):
    print_change(event.issue, event.old_labels)

def handle_error_event(event):
    sys.stderr.write(
        "ERROR: Could not relabel %(key)s: %(summary)s. JIRA error details:\n%(error)s\n" % {
            'key': event.issue.key,
            'summary': event.issue.fields.summary,
            'error': event.exception.text
        }
    )

def do_replace_label(j, old_label, new_label):
    jl = jiralabels.JiraLabels()
    jl.add_listener('LabelEvent', handle_label_event)
    jl.add_listener('ErrorEvent', handle_error_event)
    jl.replace_label(j, old_label, new_label)
            
def parse_arguments():
    parser = argparse.ArgumentParser(
        description='Replace a label in JIRA without changing other labels applied to an issue.'
    )
    parser.add_argument(
       'server',
       help='JIRA server'
    )
    parser.add_argument(
        'old',
        help='Old label'
    )
    parser.add_argument(
        'new',
        help='New label'
    )
    parser.add_argument(
        '-u',
        '--user',
        help='Username for HTTP Basic Auth (defaults to login user)',
        default=getpass.getuser()
    )

    return parser.parse_args()

def handle_signal_interrupt(signal, frame):
    sys.exit(0)

if __name__ == '__main__':
    signal.signal(signal.SIGINT, handle_signal_interrupt)
    sys.exit(main())
